# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

```bash
# Setup environment
uv venv && source .venv/bin/activate
uv pip install -e ".[dev]"

# Run application
rss-watcher -c config.yaml
rss-watcher -c config.yaml -v  # verbose mode

# Run tests (pytest-asyncio handles async tests)
pytest
pytest tests/test_filters.py -v  # single test file
pytest -k "test_keyword"         # run tests matching pattern

# Code quality
ruff check .
ruff format .

# Docker
docker build -t rss-watcher .
docker compose up -d             # start service
docker compose logs -f           # follow logs
```

## Commit Conventions

Use [Conventional Commits](https://www.conventionalcommits.org/) format:

```text
<type>(scope): <description>
```

**Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `chore`, `ci`, `build`

**Scopes for this project:** `rss`, `telegram`, `config`, `storage`, `filters`, `media`, `deps`

**Examples:**

```text
feat(rss): add per-feed cookie support for authenticated feeds
fix(telegram): handle rate limit errors gracefully
docs: update configuration examples in README
chore(deps): update aiohttp to 3.9.1
```

## Architecture Overview

Async Python application using `asyncio` for concurrent feed monitoring.

**Data Flow:**

```text
config.yaml â†’ load_config() â†’ RSSWatcher.start()
                                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                           â†“                           â†“
  _watch_feed(feed1)          _watch_feed(feed2)          _watch_feed(feedN)
        â†“                           â†“                           â†“
  FeedParser.fetch_feed() â†’ filter_entries() â†’ Storage.is_seen() â†’ MediaDownloader.process_entry() â†’ TelegramNotifier.send_entry()
```

**Module Responsibilities:**

| Module | Purpose |
| ------ | ------- |
| [main.py](rss_watcher/main.py) | `RSSWatcher` orchestrator, CLI entry point, signal handling |
| [config.py](rss_watcher/config.py) | Pydantic models, YAML loading, `${VAR:-default}` substitution |
| [filters.py](rss_watcher/filters.py) | `RSSEntry` dataclass, `EntryFilter` with AND/OR logic |
| [storage.py](rss_watcher/storage.py) | Async SQLite via `aiosqlite`, duplicate prevention per feed, feed initialization tracking |
| [rss_parser.py](rss_watcher/rss_parser.py) | `FeedParser` with `aiohttp`, retry logic, feedparser parsing, SOCKS proxy support, per-feed cookies |
| [telegram.py](rss_watcher/telegram.py) | `TelegramNotifier`, rate limiting, HTML/Markdown formatting, SOCKS proxy support |
| [media.py](rss_watcher/media.py) | `MediaDownloader`, video extraction from HTML/enclosures/Media RSS, async downloads |

**Key Design Decisions:**

- **Filter logic:** All filter types combine with AND (all must pass). Within each type, include rules use OR (any match passes).
- **First-run behavior:** Marks existing entries as seen without notifying only for *new feeds* (persisted in `feed_state` table). Restarts do not trigger this behavior.
- **Notification reliability:** Entries are marked as seen only after successful Telegram notification. Failed notifications will be retried on next check.
- **Storage:** Per-feed GUID tracking with UNIQUE constraint prevents duplicates across restarts. Feed initialization state persisted in `feed_state` table.
- **Concurrency:** Each feed runs as an independent `asyncio.Task` with its own check interval.
- **Proxy support:** Optional SOCKS proxy (`defaults.proxy`) applies to both RSS fetching (via `aiohttp-socks`) and Telegram API (via `httpx`).
- **Cookies:** Per-feed cookies can be configured for authenticated RSS feeds requiring session or auth tokens.
- **Media downloads:** Optional video download extracts videos from HTML `<video>` tags, RSS enclosures, and Media RSS extensions. Configurable globally (`defaults.media_dir`) or per-feed (`feed.media_dir`). Per-feed setting overrides default; empty string disables for a specific feed. Option `media_all_entries` downloads from all entries, not just filtered ones. Downloads occur before Telegram notification; failures are logged but don't block notifications.

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 2, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #1893 | 12:47 PM | ğŸŸ£ | Python Project Configuration with Dependencies | ~371 |
</claude-mem-context>
